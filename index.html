<html>
<head>
    <script src="https://code.jquery.com/jquery-3.1.1.min.js" integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8=" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
    <title>Issues</title>
    <style>
    /*table, th, td {
        border: border;
        border-collapse: collapse;
        padding-left: 10px;
        font-family: "Courier New";
        font-size: small;
    }
    th {
        text-align: left;
        background-color:black;
        color:white;
    }
    tr:nth-child(even) {background: #CCC}
    tr:nth-child(odd) {background: #FFF}*/
    @media print {
        a[href]:after {
            content: none !important;
        }
        .no-print {
            display: none !important;
        }
        .b-print{
            font-size: 1.4em !important;
        }
        .t-print{
            font-size: 0.8em !important;
        }
    }
    table{
        font-size: small;
    }
    thead{
        border-top: 2px solid #ddd;
    }
    #rightTop{
        float: right;
        margin-top: 8px;
        margin-right: 10px;
    }
    #project_h{
        font-size: 2em;
    }
    </style>
</head>
<body>
    <div>
        <span id="project_h" class="b-print"></span>
        <span id="rightTop" class="no-print">
            <button id="c_button" class="btn btn-default btn-xs" onClick="$('#change_project').modal()">Change Project</button>
            <span id="links"></span>
        </span>
    </div>
    <table class="table table-striped table-condensed table-hover t-print" width="100%">
        <thead>
            <tr>
                <th>Number</th>
                <th>Title</th>
                <th>Opened</th>
                <th>Assigned</th>
                <th>Milestone</th>
                <th>State</th>
            </tr>
        </thead>
        <tbody id="issues">
        </tbody>
    </table>

    <!-- Login Modal -->
    <div class="modal fade" id="login" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Login</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <input type="text" class="form-control" id="user" name="user" placeholder="Github Username">
              </div>
              <div class="form-group">
                <input type="password" class="form-control" id="pass" name="pass"  placeholder="Password">
              </div>
              <div class="form-group">
                <select class="form-control" id="project">
                    <option value="sbsgui">sbsgui</option>
                    <option value="mpro">mpro</option>
                    <option value="cpro">cpro</option>
                    <option value="tpro">tpro</option>
                    <option value="dderl">dderl</option>
                    <option value="imem">imem</option>
                <select >
                </select> 
              </div>
              <button onclick="login()" class="btn btn-default">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <!--OTP Modal -->
    <div class="modal fade" id="otp_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Two Factor Authentication</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <input type="text" class="form-control" id="otp" name="otp" placeholder="OTP">
            </div>
            <button onclick="otp()" class="btn btn-default">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <!--Failed Login -->
    <div class="modal fade" id="error" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="errorModalLabel">Unauthorized</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <label id="errorInfo">Acces Denied</label>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!--Project Change Modal-->
    <div class="modal fade" id="change_project" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
      <div class="modal-dialog modal-sm">
        <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="errorModalLabel">Change Project</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
                <select class="form-control" id="c_project">
                    <option value="sbsgui">sbsgui</option>
                    <option value="mpro">mpro</option>
                    <option value="cpro">cpro</option>
                    <option value="tpro">tpro</option>
                    <option value="dderl">dderl</option>
                    <option value="imem">imem</option>
                <select >
            </div>
            <button onclick="change_project()" class="btn btn-default">Submit</button>
          </div>
        </div>
      </div>
    </div>
    <script>
    var auth, header = {"Accept" : "application/vnd.github.v3+json"}, project, url;
    $(document).ready(function() {
        $("table").hide();
        $("#c_button").hide();
        $('#login').modal();
    });
    function login(){
        $('#login').modal('hide');
        var user = $("#user").val();
        var pass = $("#pass").val();
        project = $("#project").val();
        auth = btoa(user + ":" + pass);
        header["Authorization"] = "Basic " + auth;
        url = "https://api.github.com/repos/k2informaticsgmbh/"+project+"/issues?filter=all&state=all";
        get_issues(url);
    };
    function otp() {
        $('#otp_modal').modal('hide');
        header["X-GitHub-OTP"] = $("#otp").val();
        get_issues(url);
    }
    function change_project(){
        $('#change_project').modal('hide');
        project = $("#c_project").val();
        url = "https://api.github.com/repos/k2informaticsgmbh/"+project+"/issues?filter=all&state=all";
        get_issues(url);   
    }
    function get_issues(url) {
        $.ajax({
            type : 'GET',
            headers: header,
            url: url,
            success: function(issues, textStatus, request) {
                setTimeout(create_links, 0, request.getResponseHeader('link'));
                setTimeout(show_issues, 0, issues);
            },
            error: function(jqXHR, errorStatus, errorThrown) {
                if(jqXHR.status ==  401 && jqXHR.responseJSON.message.includes("OTP")) {
                    if(jqXHR.getResponseHeader("X-GitHub-OTP") == "required; sms") {
                        $("#errorInfo").text("Does not support SMS token for now Please use application based authentication");
                        $("#error").modal();
                    } else {              
                        $('#otp_modal').modal();
                    }
                } else {
                    console.log("Get issues failed : "+errorStatus+" "+errorThrown);
                    $("#error").modal();
                }
            }
        });
    };
    function create_links(link) {
        var links = link.split(',');
        $('#links').empty();
        for(var i = 0; i < links.length; ++i) {
            var parts = links[i].match(/\<(.*)\>.*rel="(.*)"/);
            $('#links').append(
                    $('<a href="#">')
                        .on('click', {url : parts[1]}, function(event) { 
                            get_issues(event.data.url); 
                        })
                        .text(parts[2])
                        .css('padding-left', 10)
            );
        }
    };
    function show_issues(issues) {
        $('#issues').empty();
        $("table").show();
        $("#project_h").text(project);
        $("#c_button").show();
        for(var id = 0; id < issues.length; ++id) {
            var fontWeight = "normal";
            if(issues[id].state == "open"){
                fontWeight = "bold";
            }
            $('#issues').append(
                $('<tr>').append(
                    $('<td>').html("<a href='"+ issues[id].html_url +"' target='_blank'>" + issues[id].number + "</a>"),
                    $('<td>').html(issues[id].title).css("font-weight", fontWeight),
                    $('<td>').html(issues[id].user.login).css("font-weight", fontWeight),
                    $('<td>').html(issues[id].assignee != null ? issues[id].assignee.login : '').css("font-weight", fontWeight),
                    $('<td>').html(issues[id].milestone != null ? issues[id].milestone.title : '').css("font-weight", fontWeight),
                    $('<td>').html(issues[id].state).css("font-weight", fontWeight)
                )
            );
        }
    };
    </script>
</body>
</html>
